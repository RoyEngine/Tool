# 日志系统优化方案

## 问题分析

从终端输出可以看出当前日志系统存在以下问题：
1. **格式不一致**：部分日志行缺少完整的日志格式（时间戳、模块名等）
2. **信息混乱**：不同阶段的输出混杂在一起，缺少清晰的层级关系
3. **输出截断**：部分日志行被截断或格式错乱
4. **缺少结构化**：日志内容没有明确的阶段划分

## 优化方案

### 1. 统一日志格式

修改 `logger_utils.py` 中的日志格式化器，确保所有日志输出使用统一格式：

```python
# 优化日志格式，添加阶段标记
def __init__(self, fmt=None, datefmt=None, style='%', validate=True):
    if fmt is None:
        # 添加阶段标记，使日志更具结构性
        fmt = '%(asctime)s - %(name)s - %(levelname)s - [%(error_code)s] - [%(stage)s] - %(filename)s:%(lineno)d - %(message)s'
    super().__init__(fmt, datefmt, style, validate)
    self.default_error_code = "N/A"
    self.default_stage = "GENERAL"

# 修改 format 方法，添加默认阶段
def format(self, record):
    if not hasattr(record, 'error_code'):
        record.error_code = self.default_error_code
    if not hasattr(record, 'stage'):
        record.stage = self.default_stage
    return super().format(record)
```

### 2. 优化日志配置

修改 `setup_logger` 函数，确保所有日志记录器使用统一配置：

```python
# 确保控制台输出和文件输出使用相同的日志级别
def setup_logger(name: str, log_dir: str = None, level: int = logging.INFO) -> logging.Logger:
    # 现有代码...
    
    # 使用更简洁的控制台格式，只显示关键信息
    console_formatter = LogFormatter(
        fmt='[%(levelname)s] [%(stage)s] %(message)s'
    )
    console_handler.setFormatter(console_formatter)
    
    # 文件输出使用完整格式
    file_formatter = LogFormatter()
    file_handler.setFormatter(file_formatter)
    
    # 现有代码...
```

### 3. 改进日志内容结构化

修改 `init_mode/core.py` 中的日志记录，添加明确的阶段标记：

```python
# 在重命名任务开始前添加阶段标记
logger.info("开始执行文件夹重命名任务", extra={"stage": "RENAME"})

# 在处理不同目录类型时添加阶段标记
for dir_type in ["source", "source_backup"]:
    logger.info(f"处理 {dir_type} 目录", extra={"stage": f"RENAME_{dir_type.upper()}"})
    for language in ["Chinese", "English"]:
        logger.info(f"开始重命名 {language} 下的模组文件夹", extra={"stage": f"RENAME_{dir_type.upper()}_{language.upper()}"})
        # 执行重命名操作
        # ...
        logger.info("重命名完成", extra={"stage": f"RENAME_{dir_type.upper()}_{language.upper()}"})
```

### 4. 优化控制台输出

修改日志配置，使控制台输出更简洁，只显示关键信息：

```python
# 在 setup_logger 函数中
console_formatter = LogFormatter(
    fmt='%(asctime)s [%(levelname)-5s] [%(stage)-20s] %(message)s',
    datefmt='%H:%M:%S'
)
```

### 5. 修复日志输出混乱问题

确保所有日志记录器使用相同的配置，避免多个记录器同时输出导致的混乱：

```python
# 在 main.py 中初始化日志
setup_global_logging()
```

## 预期效果

优化后，日志输出将具有以下特点：

1. **格式统一**：所有日志行使用统一的格式
2. **结构清晰**：通过阶段标记明确区分不同的执行阶段
3. **层级分明**：不同级别的日志信息有明确的视觉区分
4. **内容简洁**：控制台输出只显示关键信息，文件输出保存完整信息
5. **便于分析**：日志内容结构化，便于开发人员快速定位问题

## 实施步骤

1. 修改 `logger_utils.py` 中的日志格式化器
2. 优化 `setup_logger` 函数的配置
3. 修改 `init_mode/core.py` 中的日志记录，添加阶段标记
4. 更新其他模块的日志记录，确保使用统一的格式
5. 测试日志输出效果
6. 调整日志级别和格式，确保最佳的可读性和信息量