# 实现集中式文件夹信息设置机制

## 问题分析

在项目中，`extend_mode/core.py` 中的代码（188-266行）在 `decompile_mode`、`extend_mode` 和 `extract_mode` 中重复存在。这段代码负责：
- 递归查找包含mod_info.json的mod文件夹
- 从mod_info获取正确的mod_name
- 构建mod_id到mod_path的映射

## 解决方案

将这些功能集中到 `init_mode` 模块中，然后在各个模式中复用，消除重复代码。

## 实现步骤

### 1. 在 `init_mode/core.py` 中添加集中式mod映射功能

1. **添加 `build_mod_mappings` 函数**：
   - 构建并返回mod_id到mod_info和mod_path的映射关系
   - 支持指定mod_root路径
   - 遍历source和source_backup目录

2. **更新 `run_init_tasks` 函数**：
   - 执行 `build_mod_mappings` 并保存结果到全局变量

3. **添加访问映射的函数**：
   - `get_mod_mapping()`：获取完整的mod映射
   - `get_mod_path_by_id(mod_id)`：根据mod_id获取mod路径
   - `get_mod_info_by_path(mod_path)`：根据mod路径获取mod_info

### 2. 更新 `init_mode/__init__.py`

- 导出新添加的函数，方便其他模块调用

### 3. 移除各模式中的重复代码

1. **修改 `extend_mode/core.py`**：
   - 移除 `_build_mod_mapping` 函数中的重复代码
   - 改为调用 `init_mode` 中的 `build_mod_mappings` 函数

2. **修改 `extract_mode/core.py`**：
   - 移除类似的mod映射构建代码
   - 改为调用 `init_mode` 中的函数

3. **修改 `decompile_mode/core.py`**：
   - 移除类似的mod映射构建代码
   - 改为调用 `init_mode` 中的函数

### 4. 测试验证

- 运行项目测试，确保所有功能正常工作
- 验证mod映射关系正确构建
- 确保各模式能够正常访问映射信息

## 预期效果

1. **代码复用**：消除了三个模式中的重复代码
2. **集中管理**：所有mod映射构建逻辑集中在 `init_mode` 中
3. **一致性**：确保各模式使用相同的映射构建逻辑
4. **可维护性**：修改映射逻辑只需在一处进行
5. **性能优化**：映射关系只构建一次，避免重复计算

## 实现细节

### 1. 集中式mod映射数据结构

```python
# 全局mod映射字典
# 格式：{mod_id: {"mod_path": str, "mod_info": ModInfo, "language": str}}
mod_mappings = {}
```

### 2. 核心函数设计

```python
def build_mod_mappings(mod_root: str) -> Dict[str, Any]:
    """
    构建mod映射关系
    
    Args:
        mod_root: Localization_File路径
        
    Returns:
        Dict[str, Any]: 包含映射结果的字典
    """
    # 实现映射构建逻辑
    pass

def get_mod_mapping() -> Dict[str, Any]:
    """
    获取完整的mod映射
    
    Returns:
        Dict[str, Any]: mod映射字典
    """
    return mod_mappings
```

### 3. 调用方式

```python
# 在各模式中调用
from src.init_mode import get_mod_mapping

mod_mappings = get_mod_mapping()
# 使用映射关系
```

## 风险评估

1. **兼容性**：确保现有代码能够无缝迁移到新的集中式方案
2. **性能**：确保映射构建只执行一次，不会影响性能
3. **依赖关系**：确保各模式能够正确导入和使用 `init_mode` 中的功能

## 测试计划

1. 运行Extract模式测试
2. 运行Extend模式测试  
3. 运行Decompile模式测试
4. 验证mod映射关系正确
5. 检查日志输出，确保没有错误

通过以上实现，可以实现集中式的文件夹信息设置机制，消除各模式中的重复初始化代码，提高代码的可维护性和一致性。